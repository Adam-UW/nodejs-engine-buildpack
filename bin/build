#!/usr/bin/env bash
set -eo pipefail

layers_dir=$1
bp_dir=$(cd $(dirname $0)/..; pwd)

bootstrap_buildpack() {
  if [[ ! -f $bp_dir/bin/resolve-version ]]; then
    echo "---> Bootstrapping buildpack"
    bash "$bp_dir/bin/bootstrap" $bp_dir $layers_dir
  fi
}

install_or_reuse_parse_tools() {
  if [[ ! (-f $layers_dir/bin/jq && -f $layers_dir/bin/yj) ]]; then
    echo "---> Installing tooling"

    mkdir -p $layers_dir/bin
    rm -rf $layers_dir/bin/*

    wget -qO $layers_dir/bin/jq https://github.com/stedolan/jq/releases/download/jq-1.5/jq-linux64 \
      && chmod +x $layers_dir/bin/jq
    wget -qO $layers_dir/bin/yj https://github.com/sclevine/yj/releases/download/v2.0/yj-linux \
      && chmod +x $layers_dir/bin/yj

    echo "cache = true" > $layers_dir/bin.toml
    echo "build = false" >> $layers_dir/bin.toml
    echo "launch = false" >> $layers_dir/bin.toml
  fi
}

install_or_reuse_node() {
  local node_version=10.16.3

  if [[ $node_version == $([[ -f $layers_dir/nodejs.toml ]] && cat $layers_dir/nodejs.toml | yj -t | jq -r .metadata.version) ]]; then
    echo "---> Reusing Node $node_version"
  else
    echo "---> Downloading and extracting Node $node_version"

    mkdir -p $layers_dir/nodejs
    rm -rf $layers_dir/nodejs/*

    echo "cache = true" > $layers_dir/nodejs.toml
    echo "build = true" >> $layers_dir/nodejs.toml
    echo "launch = true" >> $layers_dir/nodejs.toml
    echo -e "[metadata]\nversion = \"$node_version\"" >> $layers_dir/nodejs.toml

    nodejs_url=https://nodejs.org/dist/v10.16.0/node-v10.16.0-linux-x64.tar.xz
    wget -q -O - "$nodejs_url" | tar -xJf - -C "$layers_dir/nodejs"
    mv $layers_dir/nodejs/node-v10.16.0-linux-x64/* $layers_dir/nodejs
    rm -r $layers_dir/nodejs/node-v10.16.0-linux-x64
  fi
}

install_or_reuse_yarn() {
  local yarn_version=1.17.3

  if $use_yarn; then
    if [[ $yarn_version == $([[ -f $layers_dir/yarn.toml ]] && cat $layers_dir/yarn.toml | yj -t | jq -r .metadata.version) ]]; then
      echo "---> Reusing yarn $yarn_version"
    else
      echo "---> Installing yarn $yarn_version"
      mkdir -p $layers_dir/yarn
      rm -rf $layers_dir/yarn/*

      echo "cache = true" > $layers_dir/yarn.toml
      echo "build = true" >> $layers_dir/yarn.toml
      echo "launch = true" >> $layers_dir/yarn.toml
      echo -e "[metadata]\nversion = \"$yarn_version\"" >> $layers_dir/yarn.toml

      npm install -g yarn@$yarn_version --prefix $layers_dir/yarn
    fi
  fi
}

[ -f ./yarn.lock ] && use_yarn=true || use_yarn=false

echo "---> Node.js Buildpack"

export PATH=$layers_dir/bin:$bp_dir/bin:$PATH
export PATH=$layers_dir/nodejs/bin:$layers_dir/yarn/bin:$PATH

rm -rf node_modules

bootstrap_buildpack
install_or_reuse_parse_tools
install_or_reuse_node
install_or_reuse_yarn

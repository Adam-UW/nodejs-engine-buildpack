#!/usr/bin/env bash
set -eo pipefail

layersdir=$1

echo "---> Node.js Buildpack"

echo "---> Downloading and extracting node"
mkdir -p $layersdir/nodejs/profile.d
echo -e "launch = true" > $layersdir/nodejs.toml

nodejs_url=https://nodejs.org/dist/v10.16.0/node-v10.16.0-linux-x64.tar.xz
wget -q -O - "$nodejs_url" | tar -xJf - -C "$layersdir/nodejs"

# Create path for build and run
node_path=$layersdir/nodejs/node-v10.16.0-linux-x64/bin:$PATH
echo "export PATH=$node_path" > $layersdir/nodejs/profile.d/setup.sh
export PATH=$node_path

[ -f ./yarn.lock ] && use_yarn=true || use_yarn=false

rm -rf node_modules
if $use_yarn; then
  echo "---> Installing yarn"
  mkdir -p $layersdir/yarn
  echo -e "cache = true" > "$layersdir/yarn.toml"
  npm install -g yarn --prefix $layersdir/yarn

  echo "---> Restoring node modules from ./yarn.lock"
  $layersdir/yarn/bin/yarn install
elif [[ -f package-lock.json ]]; then
  echo "---> Restoring node modules from ./package-lock.json"
  npm install
else
  echo "---> Installing node modules"
  npm install --no-package-lock
fi

# Set default start command
echo "processes = [{ type = 'web', command = 'npm start' }]" > "$layersdir/launch.toml"
